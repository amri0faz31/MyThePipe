name: Deploy from GHCR

on:
  workflow_run:
    workflows: ["Build and Push Container"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Create Deployment Annotation
        run: |  
          echo "Deployed image: ghcr.io/${{ github.repository }}/vetapp:latest"
          echo "Deployment time: $(date)"
          echo "Git commit: ${{ github.sha }}"

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy container to Azure
        run: |
          az webapp config container set \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ secrets.AZURE_WEBAPP_NAME }} \
            --container-image-name ghcr.io/amri0faz31/mythepipe/vetapp:latest \
            --container-registry-url https://ghcr.io \
            --container-registry-user amri0faz31 \
            --container-registry-password ${{ secrets.GITHUB_PAT }}

      - name: Restart Azure Web App
        run: |
          az webapp restart \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ secrets.AZURE_WEBAPP_NAME }}
